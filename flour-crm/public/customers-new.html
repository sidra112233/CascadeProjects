<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Customer - Flour CRM</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .sidebar .nav-link {
      color: rgba(255, 255, 255, 0.8);
      padding: 0.75rem 1rem;
      margin: 0.25rem 0;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      color: white;
      background-color: rgba(255, 255, 255, 0.2);
    }
    .main-content {
      background-color: #f8f9fa;
      min-height: 100vh;
    }
    .card {
      border: none;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
      <div class="position-sticky pt-3">
        <div class="text-center mb-4">
          <h4 class="text-white"><i class="bi bi-shop"></i> Flour CRM</h4>
          <small class="text-white-50">Welcome, Admin User</small>
        </div>

        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="sales.html"><i class="bi bi-cart-plus"></i> Sales</a></li>
          <li class="nav-item"><a class="nav-link active" href="customers.html"><i class="bi bi-people"></i> Customers</a></li>
          <li class="nav-item"><a class="nav-link" href="products.html"><i class="bi bi-box-seam"></i> Products</a></li>
          <li class="nav-item"><a class="nav-link" href="sales-agents.html"><i class="bi bi-person-badge"></i> Sales Agents</a></li>
          <li class="nav-item"><a class="nav-link" href="reports.html"><i class="bi bi-graph-up"></i> Reports</a></li>
          <li class="nav-item"><a class="nav-link" href="sales-agents.html"><i class="bi bi-person-badge"></i> Sales Agents</a></li>
        </ul>

        <hr class="text-white-50 mt-4">
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-2"></i>
            <strong>Admin User</strong>
          </a>
          <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
            <li><span class="dropdown-item-text">Role: admin</span></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
      <div class="py-4">
        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
          <h1 class="h2"><i class="bi bi-person-plus me-2"></i>Add New Customer</h1>
        </div>

        <!-- Add Customer Form -->
        <div class="card">
          <div class="card-body">
            <form id="addCustomerForm">
              <div class="mb-3">
                <label for="fullName" class="form-label">Full Name *</label>
                <input type="text" class="form-control" id="fullName" name="full_name" required>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="customerType" class="form-label">Customer Type *</label>
                  <select class="form-select" id="customerType" name="customer_type" required>
                    <option value="">Select Type</option>
                    <option value="B2B">B2B (Business)</option>
                    <option value="B2C">B2C (Consumer)</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="businessName" class="form-label">Business Name</label>
                  <input type="text" class="form-control" id="businessName" name="business_name">
                  <small class="form-text text-muted">Required for B2B customers</small>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="contact" class="form-label">Contact Number *</label>
                  <input type="tel" class="form-control" id="contact" name="contact" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="whatsapp" class="form-label">WhatsApp Number</label>
                  <input type="tel" class="form-control" id="whatsapp" name="whatsapp">
                </div>
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" name="email">
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="province" class="form-label">Province *</label>
                  <select class="form-select" id="province" name="province_id" required>
                    <option value="">Loading provinces...</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="city" class="form-label">City *</label>
                  <select class="form-select" id="city" name="city_id" required disabled>
                    <option value="">Select Province First</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="town" class="form-label">Town *</label>
                  <select class="form-select" id="town" name="town_id" required disabled>
                    <option value="">Select City First</option>
                  </select>
                </div>
              </div>

              <div class="mb-3">
                <label for="address" class="form-label">Street (Optional)</label>
                <textarea class="form-control" id="address" name="address" rows="1"></textarea>
              </div>

              <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Customer</button>
              <a href="customers.html" class="btn btn-secondary">Cancel</a>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/auth-check.js"></script>
<script>
  // Load provinces
  document.addEventListener('DOMContentLoaded', () => {
    loadProvinces();

    // Hide business name initially
    const businessNameGroup = document.getElementById('businessName').closest('.mb-3');
    businessNameGroup.style.display = 'none';
  });

  async function loadProvinces() {
    try {
      const response = await fetch('/api/locations/provinces');
      if (response.ok) {
        const provinces = await response.json();
        const provinceSelect = document.getElementById('province');
        provinceSelect.innerHTML = '<option value="">Select Province</option>';
        provinces.forEach(province => {
          const option = document.createElement('option');
          option.value = province.id;
          option.textContent = province.name;
          provinceSelect.appendChild(option);
        });
      }
    } catch (err) {
      console.error('Error loading provinces:', err);
    }
  }

  async function loadCities(provinceId) {
    try {
      const response = await fetch(`/api/locations/cities/${provinceId}`);
      if (response.ok) {
        const cities = await response.json();
        const citySelect = document.getElementById('city');
        citySelect.innerHTML = '<option value="">Select City</option>';
        citySelect.disabled = false;
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city.id;
          option.textContent = city.name;
          citySelect.appendChild(option);
        });
        // reset town
        const townSelect = document.getElementById('town');
        townSelect.innerHTML = '<option value="">Select City First</option>';
        townSelect.disabled = true;
      }
    } catch (err) {
      console.error('Error loading cities:', err);
    }
  }

  async function loadTowns(cityId) {
    try {
      const response = await fetch(`/api/locations/towns/${cityId}`);
      if (response.ok) {
        const towns = await response.json();
        const townSelect = document.getElementById('town');
        townSelect.innerHTML = '<option value="">Select Town</option>';
        townSelect.disabled = false;
        towns.forEach(town => {
          const option = document.createElement('option');
          option.value = town.id;
          option.textContent = town.name;
          townSelect.appendChild(option);
        });
      }
    } catch (err) {
      console.error('Error loading towns:', err);
    }
  }

  // Province change
  document.getElementById('province').addEventListener('change', e => {
    if (e.target.value) {
      loadCities(e.target.value);
    }
  });

  // City change
  document.getElementById('city').addEventListener('change', e => {
    if (e.target.value) {
      loadTowns(e.target.value);
    }
  });

  // Customer type toggle
  document.getElementById('customerType').addEventListener('change', function () {
    const businessNameField = document.getElementById('businessName');
    const businessNameGroup = businessNameField.closest('.mb-3');
    if (this.value === 'B2B') {
      businessNameField.required = true;
      businessNameGroup.style.display = '';
    } else {
      businessNameField.required = false;
      businessNameGroup.style.display = 'none';
    }
  });

  document.getElementById('addCustomerForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const customerData = Object.fromEntries(formData.entries());

    // Convert IDs to numbers or null
    ['province_id', 'city_id', 'town_id'].forEach(key => {
      if (customerData[key] === '') {
        customerData[key] = null;
      } else {
        customerData[key] = Number(customerData[key]);
      }
    });

    // Remove business_name if B2C
    if (customerData.customer_type === 'B2C') {
      delete customerData.business_name;
    }

    // Remove empty optional fields
    ['whatsapp', 'email', 'address'].forEach(key => {
      if (customerData[key] === '') delete customerData[key];
    });

    console.log(customerData); // Debug

    try {
      const response = await fetch('/api/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(customerData)
      });
      if (response.ok) {
        alert('Customer added successfully!');
        window.location.href = 'customers.html';
      } else {
        const error = await response.json();
        alert('Error: ' + (error.error || 'Unknown error occurred'));
      }
    } catch (err) {
      console.error('Error creating customer:', err);
      alert('Error creating customer. Please try again.');
    }
  });
</script>
</body>
</html>
